name: Terraform Infrastructure

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'terraform/**'
      - 'infrastructure/**'
      - '**.tf'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'terraform/**'
      - 'infrastructure/**'
      - '**.tf'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod

env:
  TF_VERSION: '1.7.0'
  WORKING_DIR: './terraform'

jobs:
  terraform-validate:
    name: Terraform Validate & Format Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
    
    - name: Terraform Format Check
      working-directory: ${{ env.WORKING_DIR }}
      run: terraform fmt -check -recursive
    
    - name: Terraform Init
      working-directory: ${{ env.WORKING_DIR }}
      run: terraform init -backend=false
    
    - name: Terraform Validate
      working-directory: ${{ env.WORKING_DIR }}
      run: terraform validate
    
    - name: TFLint
      uses: terraform-linters/setup-tflint@v4
      with:
        tflint_version: latest
    
    - name: Run TFLint
      working-directory: ${{ env.WORKING_DIR }}
      run: |
        tflint --init
        tflint --format compact

  terraform-security:
    name: Terraform Security Scan
    runs-on: ubuntu-latest
    needs: terraform-validate
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Run tfsec
      uses: aquasecurity/tfsec-action@v1.0.3
      with:
        working_directory: ${{ env.WORKING_DIR }}
        soft_fail: false
    
    - name: Run Checkov
      uses: bridgecrewio/checkov-action@master
      with:
        directory: ${{ env.WORKING_DIR }}
        framework: terraform
        output_format: sarif
        output_file_path: checkov-results.sarif
    
    - name: Upload Checkov results to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: checkov-results.sarif

  terraform-cost-estimate:
    name: Terraform Cost Estimation
    runs-on: ubuntu-latest
    needs: terraform-validate
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Infracost
      uses: infracost/actions/setup@v2
      with:
        api-key: ${{ secrets.INFRACOST_API_KEY }}
    
    - name: Generate Infracost estimate
      run: |
        infracost breakdown --path=${{ env.WORKING_DIR }} \
          --format=json \
          --out-file=/tmp/infracost.json
    
    - name: Post Infracost comment
      run: |
        infracost comment github --path=/tmp/infracost.json \
          --repo=$GITHUB_REPOSITORY \
          --github-token=${{ secrets.GITHUB_TOKEN }} \
          --pull-request=${{ github.event.pull_request.number }} \
          --behavior=update

  terraform-plan-dev:
    name: Terraform Plan (Development)
    runs-on: ubuntu-latest
    needs: [terraform-validate, terraform-security]
    if: github.ref == 'refs/heads/develop' || github.event.inputs.environment == 'dev'
    environment: development
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS_DEV }}
    
    - name: Terraform Init
      working-directory: ${{ env.WORKING_DIR }}
      run: |
        terraform init \
          -backend-config="resource_group_name=${{ secrets.TF_STATE_RG_DEV }}" \
          -backend-config="storage_account_name=${{ secrets.TF_STATE_SA_DEV }}" \
          -backend-config="container_name=tfstate" \
          -backend-config="key=dev.terraform.tfstate"
    
    - name: Terraform Plan
      working-directory: ${{ env.WORKING_DIR }}
      run: |
        terraform plan \
          -var-file="environments/dev.tfvars" \
          -out=tfplan-dev
    
    - name: Upload plan artifact
      uses: actions/upload-artifact@v4
      with:
        name: tfplan-dev
        path: ${{ env.WORKING_DIR }}/tfplan-dev
    
    - name: Azure Logout
      if: always()
      run: az logout

  terraform-apply-dev:
    name: Terraform Apply (Development)
    runs-on: ubuntu-latest
    needs: terraform-plan-dev
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment: development
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
    
    - name: Download plan artifact
      uses: actions/download-artifact@v4
      with:
        name: tfplan-dev
        path: ${{ env.WORKING_DIR }}
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS_DEV }}
    
    - name: Terraform Init
      working-directory: ${{ env.WORKING_DIR }}
      run: |
        terraform init \
          -backend-config="resource_group_name=${{ secrets.TF_STATE_RG_DEV }}" \
          -backend-config="storage_account_name=${{ secrets.TF_STATE_SA_DEV }}" \
          -backend-config="container_name=tfstate" \
          -backend-config="key=dev.terraform.tfstate"
    
    - name: Terraform Apply
      working-directory: ${{ env.WORKING_DIR }}
      run: terraform apply -auto-approve tfplan-dev
    
    - name: Azure Logout
      if: always()
      run: az logout

  terraform-plan-staging:
    name: Terraform Plan (Staging)
    runs-on: ubuntu-latest
    needs: [terraform-validate, terraform-security]
    if: github.ref == 'refs/heads/main' || github.event.inputs.environment == 'staging'
    environment: staging
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS_STAGING }}
    
    - name: Terraform Init
      working-directory: ${{ env.WORKING_DIR }}
      run: |
        terraform init \
          -backend-config="resource_group_name=${{ secrets.TF_STATE_RG_STAGING }}" \
          -backend-config="storage_account_name=${{ secrets.TF_STATE_SA_STAGING }}" \
          -backend-config="container_name=tfstate" \
          -backend-config="key=staging.terraform.tfstate"
    
    - name: Terraform Plan
      working-directory: ${{ env.WORKING_DIR }}
      run: |
        terraform plan \
          -var-file="environments/staging.tfvars" \
          -out=tfplan-staging
    
    - name: Upload plan artifact
      uses: actions/upload-artifact@v4
      with:
        name: tfplan-staging
        path: ${{ env.WORKING_DIR }}/tfplan-staging
    
    - name: Azure Logout
      if: always()
      run: az logout

  terraform-apply-staging:
    name: Terraform Apply (Staging)
    runs-on: ubuntu-latest
    needs: terraform-plan-staging
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: staging
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
    
    - name: Download plan artifact
      uses: actions/download-artifact@v4
      with:
        name: tfplan-staging
        path: ${{ env.WORKING_DIR }}
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS_STAGING }}
    
    - name: Terraform Init
      working-directory: ${{ env.WORKING_DIR }}
      run: |
        terraform init \
          -backend-config="resource_group_name=${{ secrets.TF_STATE_RG_STAGING }}" \
          -backend-config="storage_account_name=${{ secrets.TF_STATE_SA_STAGING }}" \
          -backend-config="container_name=tfstate" \
          -backend-config="key=staging.terraform.tfstate"
    
    - name: Terraform Apply
      working-directory: ${{ env.WORKING_DIR }}
      run: terraform apply -auto-approve tfplan-staging
    
    - name: Azure Logout
      if: always()
      run: az logout

  terraform-plan-prod:
    name: Terraform Plan (Production)
    runs-on: ubuntu-latest
    needs: terraform-apply-staging
    if: github.ref == 'refs/heads/main' || github.event.inputs.environment == 'prod'
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS_PROD }}
    
    - name: Terraform Init
      working-directory: ${{ env.WORKING_DIR }}
      run: |
        terraform init \
          -backend-config="resource_group_name=${{ secrets.TF_STATE_RG_PROD }}" \
          -backend-config="storage_account_name=${{ secrets.TF_STATE_SA_PROD }}" \
          -backend-config="container_name=tfstate" \
          -backend-config="key=prod.terraform.tfstate"
    
    - name: Terraform Plan
      working-directory: ${{ env.WORKING_DIR }}
      run: |
        terraform plan \
          -var-file="environments/prod.tfvars" \
          -out=tfplan-prod
    
    - name: Upload plan artifact
      uses: actions/upload-artifact@v4
      with:
        name: tfplan-prod
        path: ${{ env.WORKING_DIR }}/tfplan-prod
    
    - name: Azure Logout
      if: always()
      run: az logout

  terraform-apply-prod:
    name: Terraform Apply (Production)
    runs-on: ubuntu-latest
    needs: terraform-plan-prod
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event.inputs.environment == 'prod')
    environment:
      name: production
      # Manual approval required for production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
    
    - name: Download plan artifact
      uses: actions/download-artifact@v4
      with:
        name: tfplan-prod
        path: ${{ env.WORKING_DIR }}
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS_PROD }}
    
    - name: Terraform Init
      working-directory: ${{ env.WORKING_DIR }}
      run: |
        terraform init \
          -backend-config="resource_group_name=${{ secrets.TF_STATE_RG_PROD }}" \
          -backend-config="storage_account_name=${{ secrets.TF_STATE_SA_PROD }}" \
          -backend-config="container_name=tfstate" \
          -backend-config="key=prod.terraform.tfstate"
    
    - name: Terraform Apply
      working-directory: ${{ env.WORKING_DIR }}
      run: terraform apply -auto-approve tfplan-prod
    
    - name: Tag release
      if: success()
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        VERSION=$(date +'%Y.%m.%d')-${{ github.run_number }}
        git tag -a "infra-v$VERSION" -m "Infrastructure release $VERSION"
        git push origin "infra-v$VERSION"
    
    - name: Azure Logout
      if: always()
      run: az logout
